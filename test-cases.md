# テストケース設計（`game-plan.md` / `README.md` 準拠）

## 概要
`game-plan.md` と `README.md` の仕様を基準に、実装寄り詳細のテストケースを整理したドキュメントです。  
対象はスマホ向け3レーン障害物回避ゲームの `UI/画面遷移`、`ゲームロジック`、`永続化`、`レスポンシブ/端末挙動`、`エッジケース` です。

## 仕様ソース（参照元）
- `game-plan.md`
- `README.md`

## テスト方針
- 表形式
- 実装寄り詳細（境界値・失敗系を含む）
- 手動受け入れテスト + ロジック/統合テスト観点を混在
- 優先度は未付与（必要に応じて `P0/P1/P2` を後付け）

## 自動化を見据えた前提（現状コードに対応）
- `src/game.js` の公開関数（`createInitialState`, `startGame`, `updateGame`, `handleLaneTap`, `finishGame`）を直接呼び出せる
- `src/config.js` の `getStageByScore()` を直接呼び出せる
- `localStorage` はモック可能（`window.localStorage` 差し替え）
- `requestAnimationFrame` / 時刻制御は将来の統合テストでモック可能

## テストケース一覧

### 1. 画面遷移 / UI

| ID | 種別 | 観点 | 前提 | 手順 | 期待結果 |
| --- | --- | --- | --- | --- | --- |
| UI-01 | 手動/統合 | 起動初期画面 | 初回起動 | ページを開く | タイトル画面が表示される |
| UI-02 | 手動/統合 | タイトル要素表示 | タイトル画面 | 画面確認 | ゲーム名、`ゲームスタート`、最高スコア表示がある |
| UI-03 | 手動/統合 | ゲーム開始遷移 | タイトル画面 | `ゲームスタート` 押下 | インゲーム画面へ遷移し、ゲームループが開始される |
| UI-04 | 手動/統合 | リザルト遷移 | プレイ中、ライフ1 | 被弾してライフ0にする | 即時にリザルト画面へ遷移する |
| UI-05 | 手動/統合 | リザルト要素表示 | リザルト画面 | 画面確認 | 今回スコア、最高スコア、`タイトルへ` ボタンが表示される |
| UI-06 | 手動/統合 | リザルト→タイトル | リザルト画面 | `タイトルへ` 押下 | タイトル画面へ戻る |
| UI-07 | 手動/統合 | リトライ非表示 | リザルト画面 | 画面確認 | `リトライ` ボタンが存在しない |
| UI-08 | 手動/統合 | タイトル復帰後の開始条件 | 一度ゲーム終了済み | タイトルに戻って再度 `ゲームスタート` | スコア0、ライフ3、障害物空の新規ゲームとして開始される |
| UI-09 | 手動 | HUD表示 | プレイ中 | 画面確認 | 現在スコアと残りライフが表示される |
| UI-10 | 手動 | 横向き案内オーバーレイ | 端末を横向きにする | 画面回転 | 「縦持ちでプレイしてください」相当の案内オーバーレイが表示される（README基準） |
| UI-11 | 手動 | 縦向き復帰 | UI-10の状態 | 縦向きに戻す | オーバーレイが解除され、通常プレイ表示に戻る |
| UI-12 | 統合 | 画面外DOMタップ無視 | プレイ中 | Canvas外のDOM領域をタップ | レーン移動や不正入力が発生しない |

### 2. 入力操作（3レーン移動）

| ID | 種別 | 観点 | 前提 | 手順 | 期待結果 |
| --- | --- | --- | --- | --- | --- |
| IN-01 | 手動/統合 | 左レーン移動 | プレイ中 | 左1/3領域をタップ | 自機がレーン0へ即時移動する |
| IN-02 | 手動/統合 | 中央レーン移動 | プレイ中 | 中央1/3領域をタップ | 自機がレーン1へ即時移動する |
| IN-03 | 手動/統合 | 右レーン移動 | プレイ中 | 右1/3領域をタップ | 自機がレーン2へ即時移動する |
| IN-04 | ロジック | レーン境界判定（左/中央境界） | レーン判定関数 or 入力処理テスト可能 | 境界直前/境界値/直後のX座標を入力 | 境界値仕様どおりに一意なレーンへ割り当てられる |
| IN-05 | ロジック | レーン境界判定（中央/右境界） | 同上 | 境界直前/境界値/直後のX座標を入力 | 境界値仕様どおりに一意なレーンへ割り当てられる |
| IN-06 | 手動 | 連打耐性 | プレイ中 | 複数レーンを高速連打 | 入力取りこぼしが顕著でなく、最終タップ位置のレーンに追従する |
| IN-07 | 手動 | スクロール/ズーム抑止 | スマホ実機 | プレイ中に連続タップ/ダブルタップ | スクロールやズームで操作不能になりにくい（`touch-action` 効果） |

### 3. スコア / 最高スコア / 永続化

| ID | 種別 | 観点 | 前提 | 手順 | 期待結果 |
| --- | --- | --- | --- | --- | --- |
| SC-01 | ロジック/統合 | 回避でスコア加算 | 障害物1つが未被弾のまま画面下へ抜ける状態 | `updateGame` を進める | スコアが `+1` される |
| SC-02 | ロジック/統合 | 被弾障害物は加点なし | 衝突済み障害物が消去される状態 | 更新を進める | 該当障害物由来のスコア加算が発生しない |
| SC-03 | ロジック | 複数障害物同時通過 | 複数障害物が同フレームで画面下へ抜ける状態 | 更新を進める | 未被弾分の数だけスコアが加算される |
| SC-04 | 統合 | 最高スコア更新（上回る） | 既存最高スコア < 今回スコア | ゲーム終了処理 | 最高スコアが今回スコアに更新される |
| SC-05 | 統合 | 最高スコア非更新（同値） | 既存最高スコア = 今回スコア | ゲーム終了処理 | 最高スコアは維持される |
| SC-06 | 統合 | 最高スコア非更新（下回る） | 既存最高スコア > 今回スコア | ゲーム終了処理 | 最高スコアは維持される |
| SC-07 | 統合 | `localStorage` 保存キー | 保存成功環境 | プレイして最高スコア更新 | `miniGame.laneDodge.highScore` に保存される |
| SC-08 | 手動/統合 | 再読み込み後の保持 | 保存済み | ページ再読み込み | タイトル画面の最高スコアが保持される |
| SC-09 | ロジック/統合 | `localStorage` 不可時フォールバック | `localStorage` 例外をモック | 起動・プレイ・終了 | ゲーム本体は継続動作し、最高スコア保存のみスキップされる |
| SC-10 | ロジック | 不正保存値耐性 | `localStorage` に不正値（文字列/負数/null） | 起動時読込 | 0または安全な値として扱い、クラッシュしない |

### 4. 衝突判定 / ライフ / 無敵時間

| ID | 種別 | 観点 | 前提 | 手順 | 期待結果 |
| --- | --- | --- | --- | --- | --- |
| HP-01 | ロジック/統合 | 同一レーン衝突で被弾 | 自機と障害物が同一レーンかつ重なり | 更新を1フレーム進める | ライフが1減る |
| HP-02 | ロジック/統合 | 異なるレーンは非衝突 | 自機と障害物が別レーン | 更新を進める | ライフ変化なし |
| HP-03 | ロジック | 被弾障害物消去 | 衝突発生 | 更新を進める | 衝突した障害物が消去される |
| HP-04 | ロジック | 無敵時間開始 | 被弾直後 | 状態確認 | `isInvincible=true`、タイマーが `500ms` で開始される |
| HP-05 | ロジック | 無敵中の再衝突無効 | 被弾直後〜500ms未満 | 同一レーン衝突を再度発生 | ライフが追加で減らない |
| HP-06 | ロジック | 無敵時間境界（499ms） | 無敵中 | 経過 `499ms` | まだ被弾しない |
| HP-07 | ロジック | 無敵時間境界（500ms） | 無敵中 | 経過 `500ms` 以上後に衝突 | 再び被弾対象になる |
| HP-08 | 統合 | ライフ減少遷移 `3→2→1→0` | 新規ゲーム | 衝突を4回相当試行（無敵時間考慮） | ライフ表示が `3,2,1,0` と正しく推移し、0で終了 |
| HP-09 | 統合 | ゲームオーバー条件 | ライフ1 | 被弾 | ライフ0到達時点でプレイ継続せずリザルトへ遷移 |

### 5. 難易度ステージ / 境界値 / 生成ルール

| ID | 種別 | 観点 | 前提 | 手順 | 期待結果 |
| --- | --- | --- | --- | --- | --- |
| DF-01 | ロジック | Stage判定: `0` | `getStageByScore` 呼出可能 | score=`0` | Stage 1 |
| DF-02 | ロジック | Stage判定境界: `14` | 同上 | score=`14` | Stage 1 |
| DF-03 | ロジック | Stage判定境界: `15` | 同上 | score=`15` | Stage 2 |
| DF-04 | ロジック | Stage判定境界: `34` | 同上 | score=`34` | Stage 2 |
| DF-05 | ロジック | Stage判定境界: `35` | 同上 | score=`35` | Stage 3 |
| DF-06 | ロジック | Stage判定境界: `59` | 同上 | score=`59` | Stage 3 |
| DF-07 | ロジック | Stage判定境界: `60` | 同上 | score=`60` | Stage 4 |
| DF-08 | ロジック/統合 | Stage上昇時の速度反映 | scoreを閾値跨ぎに調整 | 更新を進める | 障害物速度が新ステージ値に変わる |
| DF-09 | ロジック/統合 | Stage上昇時の生成間隔反映 | 同上 | スポーン周期を観測 | 生成間隔が新ステージ値に変わる |
| DF-10 | ロジック | 1回生成数の上限 | 生成処理テスト可能 | 複数回生成 | 1回で障害物数は `1` または `2` のみ |
| DF-11 | ロジック | 同時3レーン生成禁止 | 生成処理テスト可能 | 多数回生成 | 3レーン全埋めパターンが一度も出ない |
| DF-12 | ロジック | 同時2レーン生成率（Stage1） | Stage1固定・多数サンプル | 生成を統計観測 | 2レーン生成が `0%`（発生しない） |
| DF-13 | ロジック | 直前完全一致回避 | 生成処理テスト可能 | 連続生成を観測 | 直前と完全一致パターンの連続発生が抑制される（仕様どおり） |

### 6. ゲームループ / 時間依存 / 安定性

| ID | 種別 | 観点 | 前提 | 手順 | 期待結果 |
| --- | --- | --- | --- | --- | --- |
| LP-01 | ロジック | `deltaTime` 正常更新 | `updateGame` 呼出可能 | `deltaMs` を通常値（16ms前後）で進める | 障害物位置が時間比例で更新される |
| LP-02 | ロジック | 低FPS耐性 | 同上 | 大きめ `deltaMs`（例: 100ms, 200ms）で更新 | 速度が破綻せず、著しい不正挙動がない |
| LP-03 | 統合 | 復帰直後の大ジャンプ抑止 | `visibilitychange` 実装あり | 非表示→表示に戻す | 復帰直後に障害物が大きくワープしない |
| LP-04 | ロジック/統合 | ゲーム終了後ループ停止 | ライフ0到達後 | 追加フレーム進行 | スコア/障害物更新が継続しない |
| LP-05 | 統合 | 再ゲーム開始時の状態リセット | 一度終了済み | 再スタート | `elapsedMs`, `spawnTimerMs`, `invincible` 状態が初期化される |

### 7. レスポンシブ / 表示崩れ

| ID | 種別 | 観点 | 前提 | 手順 | 期待結果 |
| --- | --- | --- | --- | --- | --- |
| RS-01 | 手動 | 360px幅表示 | 縦向き | 幅 `360px` 相当で表示 | UI/Canvas/HUD/ボタンが崩れない |
| RS-02 | 手動 | 390px幅表示 | 縦向き | 幅 `390px` 相当で表示 | 表示崩れなし |
| RS-03 | 手動 | 430px幅表示 | 縦向き | 幅 `430px` 相当で表示 | 表示崩れなし |
| RS-04 | 手動 | タイトル/リザルトの可読性 | 各画面表示 | 文字・ボタン確認 | テキスト欠けやボタン押下不可がない |
| RS-05 | 手動 | PCブラウザ最低限動作 | PCブラウザ | 起動〜1プレイ | スマホ向け見た目でも操作・遷移は可能 |

## 受け入れ判定（最低ライン）
- `UI-01`〜`UI-08` が全て合格
- `IN-01`〜`IN-03` が合格
- `SC-01`, `SC-02`, `SC-04`, `SC-08` が合格
- `HP-01`, `HP-05`, `HP-08`, `HP-09` が合格
- `DF-03`, `DF-05`, `DF-07`, `DF-11` が合格
- `RS-01`〜`RS-03` が合格

## テストデータ / 準備物（推奨）
- `localStorage` 正常/例外/不正値の3パターン
- スコア境界値用の状態（`14`, `15`, `34`, `35`, `59`, `60`）
- 無敵時間境界値用の時刻制御（`499ms`, `500ms`）
- 生成ルール検証用の多数試行（統計確認）

## 実施メモ（任意）
- 手動テスト時は実機（iPhone Safari / Android Chrome のどちらか1系統以上）を優先
- `UI-10`, `UI-11`, `IN-07`, `RS-*` は実機またはデバイスエミュレーションで確認
- 将来自動化する場合は、ロジック系を先に `src/game.js` / `src/config.js` 対象で切り出す

## 明示的な前提・デフォルト
- `README.md` の横向きオーバーレイ記述を優先し、横向き時は案内表示ありとしてテスト化
- 「直前パターン完全一致回避」は確率的仕様のため、厳密率ではなく「連続完全一致が抑制される」挙動確認とする
- 実装寄り詳細のため、手動テストだけでなくロジック/統合テスト観点も含めた
- 自動化に未対応でも、この一覧をそのまま手動テスト項目として使用可能
