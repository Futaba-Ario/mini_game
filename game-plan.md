# 3レーン障害物回避ゲーム（スマホ向け）実装プラン

## 概要
空のリポジトリかつ Node 未導入のため、依存なしで動くスマホ向けブラウザゲームとして `HTML + CSS + 素のJavaScript (ES Modules)` で実装する前提にします。  
インゲーム描画は `Canvas`、タイトル/リザルトUIは `DOM` で構成します。

## 仕様確定（今回の合意内容）
- 操作: 自機を3レーン間でタップ移動
- ライフ制: 3ライフ
- 難易度: 段階的に上昇
- 向き: 縦持ち専用
- スコア: 回避数ベース
- 見た目: シンプルUI / 図形ベース
- リザルト画面ボタン: `タイトルへ` のみ（`リトライ` は入れない）

## 画面仕様
### 1. タイトル画面
- 表示要素: ゲーム名、`ゲームスタート` ボタン、最高スコア
- 最高スコアは `localStorage` から読み込み
- `ゲームスタート` 押下でゲーム初期化してインゲームへ遷移

### 2. インゲーム画面
- 3レーンを縦持ち画面いっぱいに表示
- 自機は下部固定Y位置、レーンのみ移動
- 画面上部から障害物が落下
- タップしたレーンへ自機を即時移動
- HUD表示: 現在スコア（回避数）、残りライフ（3→0）
- ライフが0になったらリザルトへ遷移

### 3. リザルト画面
- 今回スコア
- 最高スコア（更新後）
- `タイトルへ` ボタン
- `タイトルへ` でタイトル画面へ戻る（次回はタイトルから開始）

## ゲームルール詳細（実装で迷わないための固定値）
### 基本ルール
- 自機と障害物が同一レーンで重なったら被弾
- 被弾時: ライフ `-1`、該当障害物は消去
- 連続被弾防止: 被弾後 `500ms` 無敵
- スコア加算条件: 障害物が画面下へ抜けた時（未被弾分のみ）に `+1`
- ゲームオーバー条件: ライフが `0` になった時点

### 難易度ステージ（段階的上昇）
- Stage 1: スコア `0-14`
- Stage 2: スコア `15-34`
- Stage 3: スコア `35-59`
- Stage 4: スコア `60+`

### ステージ別パラメータ（仮想座標 360x640 基準）
- Stage 1: 速度 `420 px/s`、生成間隔 `900ms`、同時2レーン生成確率 `0%`
- Stage 2: 速度 `520 px/s`、生成間隔 `760ms`、同時2レーン生成確率 `10%`
- Stage 3: 速度 `630 px/s`、生成間隔 `620ms`、同時2レーン生成確率 `20%`
- Stage 4: 速度 `760 px/s`、生成間隔 `500ms`、同時2レーン生成確率 `30%`

### 生成ルール（理不尽防止）
- 1回の生成で出す障害物は `1個` または `2個`
- 同時3レーン生成は禁止（常に最低1レーンは空ける）
- 連続で同じパターンが極端に続かないよう、直前パターンと完全一致を避ける
- 障害物サイズはレーン幅の `70%` 程度、見やすさ優先で固定

## 技術構成（実装方針）
### 採用方式
- `index.html`: 画面コンテナ・ボタン・Canvas
- `styles.css`: 縦持ちUI、レーン背景、ボタン、画面切替
- `src/*.js`: ゲーム状態、入力、描画、障害物生成、永続化

### 描画/入力
- 描画: `CanvasRenderingContext2D`
- ループ: `requestAnimationFrame`（`deltaTime` ベース更新）
- 入力: `pointerdown` を基本にし、タップ位置からレーン判定
- スマホ対策: `touch-action: manipulation`、スクロール/ズーム誤作動を抑制

## 追加・変更する公開インターフェース / 型（内部APIとして固定）
実装者が迷わないよう、モジュール間のI/Fを先に定義します（JS + JSDoc想定）。

### 状態型（JSDoc typedef）
- `ScreenState = 'title' | 'playing' | 'result'`
- `LaneIndex = 0 | 1 | 2`
- `GameState`
- `Obstacle`
- `DifficultyStage`

### `GameState`（主要プロパティ）
- `screen`
- `score`
- `highScore`
- `lives`
- `playerLane`
- `obstacles`
- `spawnTimerMs`
- `elapsedMs`
- `isInvincible`
- `invincibleTimerMs`
- `rngSeed`（任意、再現性が必要なら使用）

### 想定モジュールと主要関数
- `src/config.js`
- `getStageByScore(score)`
- `src/storage.js`
- `loadHighScore()`
- `saveHighScore(score)`
- `src/game.js`
- `createInitialState(highScore)`
- `startGame(state)`
- `updateGame(state, deltaMs)`
- `handleLaneTap(state, laneIndex)`
- `finishGame(state)`（結果確定・最高スコア更新判定）
- `src/render.js`
- `renderTitle(ctx/dom, state)`
- `renderGame(ctx, state)`
- `renderResult(ctx/dom, state)`
- `src/main.js`
- `bootstrap()`
- `switchScreen(nextScreen)`

### 永続化キー
- `localStorage` キー: `miniGame.laneDodge.highScore`

## データフロー（画面遷移と処理順）
1. 起動時に `highScore` を `localStorage` から読み込む
2. タイトル画面に表示
3. `ゲームスタート` で `GameState` 初期化（スコア0、ライフ3、障害物空）
4. `requestAnimationFrame` 開始
5. 毎フレーム: 入力反映 → スポーン判定 → 障害物更新 → 衝突判定 → スコア加算判定 → 描画
6. ライフ0でゲーム終了処理
7. 最高スコア更新なら保存
8. リザルト画面表示
9. `タイトルへ` でタイトル画面へ戻る（最高スコアは保持）

## 実装ステップ（順序固定）
1. `index.html` の画面骨組み作成（タイトル/ゲーム/リザルト）
2. `styles.css` で縦持ち専用レイアウト、画面切替、ボタンUI実装
3. `config.js` にゲーム定数（サイズ・速度・ステージ閾値）定義
4. `storage.js` で最高スコア読み書き実装
5. `game.js` で状態管理、スポーン、更新、衝突、スコア処理実装
6. `render.js` でCanvas描画（レーン、自機、障害物、HUD）
7. `main.js` でイベント接続（スタート、タイトル戻り、タップ入力、ループ開始/停止）
8. 実機/エミュレータ前提の動作確認とパラメータ微調整
9. 受け入れテスト実施（下記）

## テストケース / シナリオ（受け入れ基準）
### 画面遷移
- 起動時にタイトル画面が表示される
- タイトルの `ゲームスタート` でインゲームへ遷移する
- ライフ0でリザルト画面へ遷移する
- リザルトの `タイトルへ` でタイトルに戻る

### スコア/最高スコア
- 障害物を1つ回避するとスコアが `+1` される
- 被弾して消えた障害物ではスコア加算されない
- 今回スコアが最高スコアを超えた場合に更新される
- ページ再読み込み後も最高スコアが保持される

### 操作性
- 3レーンのどこをタップしても対応レーンに自機が移動する
- 連打しても入力が取りこぼされにくい
- 画面スクロールやダブルタップズームで操作が崩れない（可能な範囲で抑止）

### 衝突/ライフ
- 同一レーン接触でライフが1減る
- 被弾直後 `500ms` は連続被弾しない
- ライフが `3 -> 2 -> 1 -> 0` と正しく減る

### 難易度
- スコア閾値到達でステージが上がる
- ステージ上昇後に速度/生成間隔が変化する
- 同時3レーン障害物が生成されない

### レスポンシブ（縦持ち専用）
- 代表的スマホ幅（360px / 390px / 430px）で表示崩れしない
- 横向き時は「縦持ち推奨」表示または簡易非対応表示を出す（実装時に明示）

## エッジケース / 失敗時対応
- `localStorage` 使用不可時: 最高スコア保存を諦めて `0` 扱いで継続（ゲーム本体は動作）
- 低FPS時: `deltaTime` 更新で速度が破綻しないようにする
- フォーカス喪失時: 一時停止または内部更新停止（最低限、復帰時の大ジャンプ防止）
- 画面外タップ: 無視（Canvas外DOM領域）
- 高速連続被弾: 無敵時間で抑制

## 監視 / ロールアウト（静的配布前提）
- バックエンドなし、配布物は静的ファイルのみ
- 初期はデバッグ用 `console.debug` を入れてもよいが、最終版で無効化または最小化
- 実機確認を優先（iPhone Safari / Android Chrome のどちらか1系統以上）

## 明示的な前提・デフォルト（未指定のため本プランで採用）
- 対象はスマホブラウザ（ネイティブアプリ化は対象外）
- 音（BGM/SE）は初期版では実装しない
- 画像素材は使わず、図形描画とCSSで構成する
- リザルト画面のボタンはユーザー指定どおり `タイトルへ` のみ
- インゲーム画面には仕様補完として `現在スコア` と `残りライフ` を表示する
